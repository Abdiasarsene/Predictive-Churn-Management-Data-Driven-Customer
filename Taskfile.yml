version: "3"

env:
  COMPOSE_FILE: docker-compose.yml
  MLFLOW_TRACKING_URI: http://mlflow:5000

tasks:
  build:
    desc: "âš™ï¸ Build docker image"
    cmds:
      - docker compose -f $COMPOSE_FILE build

  up:
    desc: "ğŸš€ Launch all services (MLFLOW, API, Prometheus, Grafana)"
    cmds:
      - docker compose -f $COMPOSE_FILE up -d

  down:
    desc: "ğŸ”´ Stop Services"
    cmds:
      - docker compose -f $COMPOSE_FILE down

  restart:
    desc: "ğŸ§· Restart all Services"
    cmds:
      - task: down
      - task: up

  logs:
    desc: "ğŸ“ƒ Check logs"
    cmds:
      - docker compose -f $COMPOSE_FILE logs -f --tail=50

  api:
    desc: "ğŸ“Š Launch MLflow Server"
    cmds:
      - docker compose -f $COMPOSE_FILE up -d mlflow

  prometheus:
    desc: "ğŸ” Launch only Prometheus"
    cmds:
      - docker compose -f $COMPOSE_FILE up -d prometheus

  grafana:
    desc: "ğŸš€ Launch Grafana"
    cmds:
      - docker compose -f $COMPOSE_FILE up -d grafana

  clean:
    desc: "ğŸš¨ Remove all containers, volumes, images unused"
    cmds:
      - docker compose -f $COMPOSE_FILE down -v --remove-orphans

  clean-all:
    desc: "ğŸš¨ Remove all containers, volumes, images unused"
    cmds:
      - docker compose -f $COMPOSE_FILE down -v --remove-orphans
      - docker image prune -f

  status:
    desc: "â†”ï¸ State of containers"
    cmds:
      - docker compose -f $COMPOSE_FILE ps

  shell-api:
    desc: "ğŸ–¥ï¸ Open up shell in API containers"
    cmds:
      - docker comppse -f $COMPOSE_FILE exec api sh

  show-env:
    desc: "ğŸ” Show currents environments variables"
    cmds:
      - printenv | grep -E "MLFLOW|ENV_MODE|API"

  test:
    desc: "âš™ï¸ Launch tests (Docker)"
    deps: [build]
    cmds:
    - docker compose -f $COMPOSE_FILE run --rm api pytest

  debug:
    desc: "ğŸŸ¢ Debug : Containers + Ports"
    cmds:
      - docker ps
      - docker compose -f $COMPOSE_FILE ps
      - docker compose -f $COMPOSE_FILE logs --tail=30

  reload-env:
    desc: "ğŸ”ƒ Reload files .env in containers (down + up)"
    cmds:
      - task down
      - task up